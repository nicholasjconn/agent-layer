#!/usr/bin/env bash
set -euo pipefail

# Ensure generated agent-layer files are up to date before commit.
die() {
  echo "ERROR: $*" >&2
  exit 2
}

# Resolve the git repo root to locate the correct test runner.
repo_root="$(git rev-parse --show-toplevel 2> /dev/null || true)"
if [[ -z "$repo_root" ]]; then
  die "pre-commit must run inside a git repository."
fi

# Prefer the agent-layer repo runner, otherwise use the consumer runner.
if [[ -x "$repo_root/tests/run.sh" ]]; then
  test_runner="$repo_root/tests/run.sh"
  (cd "$repo_root" && "$test_runner" --temp-parent-root)
elif [[ -x "$repo_root/.agent-layer/tests/run.sh" ]]; then
  test_runner="$repo_root/.agent-layer/tests/run.sh"
  (cd "$repo_root" && "$test_runner" --parent-root "$repo_root")
else
  die "Missing tests/run.sh (agent-layer) or .agent-layer/tests/run.sh (consumer repo)."
fi
